<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Admin Dashboard - C Faculty Manager</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="icon" type="image/png" href="/static/images/images.png">
    <style>
        .super-admin-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            background: #f8fafc;
            padding: 10px;
            border-radius: 10px;
        }
        
        .tab-btn {
            padding: 12px 20px;
            border: none;
            background: white;
            cursor: pointer;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #64748b;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .tab-btn:hover {
            background: #e2e8f0;
        }
        
        .tab-btn.active {
            background: #2563eb;
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 14px;
        }
        
        .data-table th,
        .data-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .data-table th {
            background: #f8fafc;
            font-weight: 600;
            color: #334155;
        }
        
        .data-table tr:hover {
            background: #f8fafc;
        }
        
        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            margin-right: 5px;
            transition: all 0.2s;
        }
        
        .btn-edit {
            background: #fbbf24;
            color: #000;
        }
        
        .btn-delete {
            background: #ef4444;
            color: white;
        }
        
        .btn-add {
            background: #22c55e;
            color: white;
            padding: 10px 20px;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        
        .action-btn:hover {
            opacity: 0.8;
            transform: scale(1.05);
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .modal-header h3 {
            margin: 0;
            color: #1e293b;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #64748b;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .form-row.single {
            grid-template-columns: 1fr;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .stat-card .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #2563eb;
        }
        
        .stat-card .stat-label {
            color: #64748b;
            font-size: 14px;
            margin-top: 5px;
        }
        
        .stat-card.success .stat-value { color: #22c55e; }
        .stat-card.warning .stat-value { color: #f59e0b; }
        .stat-card.info .stat-value { color: #0ea5e9; }
        
        .table-container {
            overflow-x: auto;
        }
        
        .badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .badge-active {
            background: #dcfce7;
            color: #166534;
        }
        
        .badge-inactive {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .search-filter {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .search-filter input,
        .search-filter select {
            padding: 10px 15px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .search-filter input {
            flex: 1;
            min-width: 200px;
        }
        
        textarea.form-control {
            min-height: 100px;
            resize: vertical;
        }
    </style>
</head>
<body>
    <div class="page-wrapper">
        <!-- Navbar -->
        <nav class="navbar">
            <div class="container">
                <a href="/" class="navbar-brand">
                    <i class="material-icons">computer</i> C Faculty Manager
                </a>
                <ul class="navbar-nav">
                    <li><span style="color: white; display: flex; align-items: center; gap: 6px;">
                        <i class="material-icons" style="font-size: 20px;">admin_panel_settings</i> Super Admin
                    </span></li>
                    <li><a href="#" onclick="logout()" class="nav-btn">Logout</a></li>
                </ul>
            </div>
        </nav>

        <!-- Dashboard -->
        <div class="dashboard">
            <div class="container">
                <div class="dashboard-header">
                    <h1 class="dashboard-title">
                        <i class="material-icons" style="vertical-align: middle; margin-right: 8px;">settings</i>
                        Super Admin Dashboard
                    </h1>
                </div>

                <!-- Stats -->
                <div class="stats-grid" id="statsGrid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalFaculties">-</div>
                        <div class="stat-label">Total Faculties</div>
                    </div>
                    <div class="stat-card success">
                        <div class="stat-value" id="totalDepartments">-</div>
                        <div class="stat-label">Departments</div>
                    </div>
                    <div class="stat-card warning">
                        <div class="stat-value" id="totalTimetable">-</div>
                        <div class="stat-label">Timetable Entries</div>
                    </div>
                    <div class="stat-card info">
                        <div class="stat-value" id="totalFaqs">-</div>
                        <div class="stat-label">FAQs</div>
                    </div>
                </div>

                <!-- Tabs -->
                <div class="super-admin-tabs">
                    <button class="tab-btn active" onclick="showTab('faculties')">
                        <i class="material-icons">people</i> Faculties
                    </button>
                    <button class="tab-btn" onclick="showTab('timetable')">
                        <i class="material-icons">schedule</i> Timetable
                    </button>
                    <button class="tab-btn" onclick="showTab('dailyentries')">
                        <i class="material-icons">assignment_turned_in</i> Daily Entries
                    </button>
                    <button class="tab-btn" onclick="showTab('syllabus')">
                        <i class="material-icons">menu_book</i> Syllabus
                    </button>
                    <button class="tab-btn" onclick="showTab('labprograms')">
                        <i class="material-icons">science</i> Lab Programs
                    </button>
                    <button class="tab-btn" onclick="showTab('faqs')">
                        <i class="material-icons">help</i> FAQs
                    </button>
                    <button class="tab-btn" onclick="showTab('departments')">
                        <i class="material-icons">business</i> Departments
                    </button>
                </div>

                <!-- Tab Contents -->
                
                <!-- Faculties Tab -->
                <div id="faculties-tab" class="tab-content active">
                    <div class="card">
                        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                            <h3 class="card-title"><i class="material-icons" style="vertical-align: middle;">people</i> Manage Faculties</h3>
                            <button class="action-btn btn-add" onclick="openModal('faculty', 'add')">
                                <i class="material-icons" style="font-size: 18px;">add</i> Add Faculty
                            </button>
                        </div>
                        <div style="padding: 20px;">
                            <div class="table-container">
                                <table class="data-table" id="facultiesTable">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Name</th>
                                            <th>Email</th>
                                            <th>Phone</th>
                                            <th>Department</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Timetable Tab -->
                <div id="timetable-tab" class="tab-content">
                    <div class="card">
                        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                            <h3 class="card-title"><i class="material-icons" style="vertical-align: middle;">schedule</i> Manage Timetable</h3>
                            <button class="action-btn btn-add" onclick="openModal('timetable', 'add')">
                                <i class="material-icons" style="font-size: 18px;">add</i> Add Entry
                            </button>
                        </div>
                        <div style="padding: 20px;">
                            <div class="search-filter">
                                <select id="timetableDayFilter" onchange="filterTimetable()">
                                    <option value="">All Days</option>
                                    <option value="Monday">Monday</option>
                                    <option value="Tuesday">Tuesday</option>
                                    <option value="Wednesday">Wednesday</option>
                                    <option value="Thursday">Thursday</option>
                                    <option value="Friday">Friday</option>
                                    <option value="Saturday">Saturday</option>
                                </select>
                                <select id="timetableTypeFilter" onchange="filterTimetable()">
                                    <option value="">All Types</option>
                                    <option value="theory">Theory</option>
                                    <option value="lab">Lab</option>
                                    <option value="mini_project">Mini Project</option>
                                </select>
                            </div>
                            <div class="table-container">
                                <table class="data-table" id="timetableTable">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Faculty</th>
                                            <th>Department</th>
                                            <th>Day</th>
                                            <th>Period</th>
                                            <th>Type</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Daily Entries Tab -->
                <div id="dailyentries-tab" class="tab-content">
                    <div class="card">
                        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                            <h3 class="card-title"><i class="material-icons" style="vertical-align: middle;">assignment_turned_in</i> Manage Daily Entries (Faculty Filled Data)</h3>
                        </div>
                        <div style="padding: 20px;">
                            <div class="search-filter">
                                <input type="date" id="dailyEntriesStartDate" onchange="filterDailyEntries()">
                                <input type="date" id="dailyEntriesEndDate" onchange="filterDailyEntries()">
                                <select id="dailyEntriesFacultyFilter" onchange="filterDailyEntries()">
                                    <option value="">All Faculties</option>
                                </select>
                                <select id="dailyEntriesTypeFilter" onchange="filterDailyEntries()">
                                    <option value="">All Types</option>
                                    <option value="theory">Theory</option>
                                    <option value="lab">Lab</option>
                                    <option value="mini_project">Mini Project</option>
                                </select>
                                <button class="action-btn btn-add" onclick="loadDailyEntries()" style="padding: 10px 15px;">
                                    <i class="material-icons" style="font-size: 16px;">refresh</i> Refresh
                                </button>
                            </div>
                            <div class="table-container">
                                <table class="data-table" id="dailyEntriesTable">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Session Date</th>
                                            <th>Faculty</th>
                                            <th>Department</th>
                                            <th>Period</th>
                                            <th>Type</th>
                                            <th>Topic/Content</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Syllabus Tab -->
                <div id="syllabus-tab" class="tab-content">
                    <div class="card">
                        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                            <h3 class="card-title"><i class="material-icons" style="vertical-align: middle;">menu_book</i> Manage Syllabus</h3>
                            <button class="action-btn btn-add" onclick="openModal('syllabus', 'add')">
                                <i class="material-icons" style="font-size: 18px;">add</i> Add Session
                            </button>
                        </div>
                        <div style="padding: 20px;">
                            <div class="table-container">
                                <table class="data-table" id="syllabusTable">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Session #</th>
                                            <th>Title</th>
                                            <th>Unit</th>
                                            <th>PPT URL</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Lab Programs Tab -->
                <div id="labprograms-tab" class="tab-content">
                    <div class="card">
                        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                            <h3 class="card-title"><i class="material-icons" style="vertical-align: middle;">science</i> Manage Lab Programs</h3>
                            <button class="action-btn btn-add" onclick="openModal('labprogram', 'add')">
                                <i class="material-icons" style="font-size: 18px;">add</i> Add Program
                            </button>
                        </div>
                        <div style="padding: 20px;">
                            <div class="table-container">
                                <table class="data-table" id="labProgramsTable">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Program #</th>
                                            <th>Title</th>
                                            <th>Description</th>
                                            <th>Moodle URL</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- FAQs Tab -->
                <div id="faqs-tab" class="tab-content">
                    <div class="card">
                        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                            <h3 class="card-title"><i class="material-icons" style="vertical-align: middle;">help</i> Manage FAQs</h3>
                            <button class="action-btn btn-add" onclick="openModal('faq', 'add')">
                                <i class="material-icons" style="font-size: 18px;">add</i> Add FAQ
                            </button>
                        </div>
                        <div style="padding: 20px;">
                            <div class="table-container">
                                <table class="data-table" id="faqsTable">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Question</th>
                                            <th>Answer</th>
                                            <th>Category</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Departments Tab -->
                <div id="departments-tab" class="tab-content">
                    <div class="card">
                        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                            <h3 class="card-title"><i class="material-icons" style="vertical-align: middle;">business</i> Manage Departments</h3>
                            <button class="action-btn btn-add" onclick="openModal('department', 'add')">
                                <i class="material-icons" style="font-size: 18px;">add</i> Add Department
                            </button>
                        </div>
                        <div style="padding: 20px;">
                            <div class="table-container">
                                <table class="data-table" id="departmentsTable">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Name</th>
                                            <th>Code</th>
                                            <th>Room No</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- Footer -->
        <footer class="footer">
            <div class="container">
                <p>&copy; 2026 C Programming Faculty Management System - Super Admin</p>
            </div>
        </footer>
    </div>

    <!-- Modal for Add/Edit -->
    <div class="modal" id="crudModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Add Item</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <form id="crudForm" onsubmit="submitForm(event)">
                <div id="modalFormContent"></div>
                <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn" style="background: #e2e8f0; color: #334155;" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="submitBtn">Save</button>
                </div>
            </form>
        </div>
    </div>

    <script src="/static/js/app.js?v=3"></script>
    <script>
        // Check authentication
        const token = localStorage.getItem('token');
        const userType = localStorage.getItem('userType');
        
        if (!token || userType !== 'super_admin') {
            window.location.href = '/cprog_portal_m2p8';
        }

        // Data storage
        let facultiesData = [];
        let timetableData = [];
        let syllabusData = [];
        let labProgramsData = [];
        let faqsData = [];
        let departmentsData = [];
        let dailyEntriesData = [];

        // Current edit state
        let currentEditType = '';
        let currentEditId = null;

        // API Helper with auth
        async function apiRequestAuth(endpoint, method = 'GET', data = null) {
            const headers = {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            };
            
            const options = { method, headers };
            if (data) options.body = JSON.stringify(data);
            
            const response = await fetch(endpoint, options);
            if (response.status === 401) {
                localStorage.clear();
                window.location.href = '/cprog_portal_m2p8';
                return;
            }
            
            return await response.json();
        }

        // Tab switching
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            
            document.getElementById(`${tabName}-tab`).classList.add('active');
            event.target.closest('.tab-btn').classList.add('active');
        }

        // Load all data
        async function loadAllData() {
            showLoading();
            try {
                const [stats, faculties, timetable, syllabus, labPrograms, faqs, departments, dailyEntries] = await Promise.all([
                    apiRequestAuth('/api/super-admin/stats'),
                    apiRequestAuth('/api/super-admin/faculties'),
                    apiRequestAuth('/api/super-admin/timetable'),
                    apiRequestAuth('/api/super-admin/syllabus'),
                    apiRequestAuth('/api/super-admin/lab-programs'),
                    apiRequestAuth('/api/super-admin/faqs'),
                    apiRequestAuth('/api/super-admin/departments'),
                    apiRequestAuth('/api/super-admin/daily-entries')
                ]);

                // Update stats
                document.getElementById('totalFaculties').textContent = stats.total_faculties;
                document.getElementById('totalDepartments').textContent = stats.total_departments;
                document.getElementById('totalTimetable').textContent = stats.total_timetable_entries;
                document.getElementById('totalFaqs').textContent = stats.total_faqs;

                // Store data
                facultiesData = faculties;
                timetableData = timetable;
                syllabusData = syllabus;
                labProgramsData = labPrograms;
                faqsData = faqs;
                departmentsData = departments;
                dailyEntriesData = dailyEntries;

                // Render tables
                renderFacultiesTable();
                renderTimetableTable();
                renderSyllabusTable();
                renderLabProgramsTable();
                renderFaqsTable();
                renderDepartmentsTable();
                renderDailyEntriesTable();
                populateFacultyFilter();

            } catch (error) {
                console.error('Error loading data:', error);
                showAlert('Error loading data');
            }
            hideLoading();
        }

        // Render functions
        function renderFacultiesTable() {
            const tbody = document.querySelector('#facultiesTable tbody');
            tbody.innerHTML = facultiesData.map(f => `
                <tr>
                    <td>${f.id}</td>
                    <td>${f.name}</td>
                    <td>${f.email}</td>
                    <td>${f.phone || '-'}</td>
                    <td>${f.department || '-'}</td>
                    <td><span class="badge ${f.is_active ? 'badge-active' : 'badge-inactive'}">${f.is_active ? 'Active' : 'Inactive'}</span></td>
                    <td>
                        <button class="action-btn btn-edit" onclick="openModal('faculty', 'edit', ${f.id})">
                            <i class="material-icons" style="font-size: 14px;">edit</i>
                        </button>
                        <button class="action-btn btn-delete" onclick="deleteItem('faculty', ${f.id})">
                            <i class="material-icons" style="font-size: 14px;">delete</i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function renderTimetableTable() {
            const tbody = document.querySelector('#timetableTable tbody');
            const dayFilter = document.getElementById('timetableDayFilter').value;
            const typeFilter = document.getElementById('timetableTypeFilter').value;
            
            let filtered = timetableData;
            if (dayFilter) filtered = filtered.filter(t => t.day === dayFilter);
            if (typeFilter) filtered = filtered.filter(t => t.class_type === typeFilter);
            
            tbody.innerHTML = filtered.map(t => `
                <tr>
                    <td>${t.id}</td>
                    <td>${t.faculty_name}</td>
                    <td>${t.department_code}</td>
                    <td>${t.day}</td>
                    <td>${t.period}</td>
                    <td><span class="badge badge-active">${t.class_type}</span></td>
                    <td>
                        <button class="action-btn btn-edit" onclick="openModal('timetable', 'edit', ${t.id})">
                            <i class="material-icons" style="font-size: 14px;">edit</i>
                        </button>
                        <button class="action-btn btn-delete" onclick="deleteItem('timetable', ${t.id})">
                            <i class="material-icons" style="font-size: 14px;">delete</i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function filterTimetable() {
            renderTimetableTable();
        }

        function renderSyllabusTable() {
            const tbody = document.querySelector('#syllabusTable tbody');
            tbody.innerHTML = syllabusData.map(s => `
                <tr>
                    <td>${s.id}</td>
                    <td>${s.session_number}</td>
                    <td>${s.session_title}</td>
                    <td>Unit ${s.unit}</td>
                    <td>${s.ppt_url ? `<a href="${s.ppt_url}" target="_blank">Link</a>` : '-'}</td>
                    <td>
                        <button class="action-btn btn-edit" onclick="openModal('syllabus', 'edit', ${s.id})">
                            <i class="material-icons" style="font-size: 14px;">edit</i>
                        </button>
                        <button class="action-btn btn-delete" onclick="deleteItem('syllabus', ${s.id})">
                            <i class="material-icons" style="font-size: 14px;">delete</i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function renderLabProgramsTable() {
            const tbody = document.querySelector('#labProgramsTable tbody');
            tbody.innerHTML = labProgramsData.map(p => `
                <tr>
                    <td>${p.id}</td>
                    <td>${p.program_number}</td>
                    <td>${p.program_title}</td>
                    <td>${p.description ? p.description.substring(0, 50) + '...' : '-'}</td>
                    <td>${p.moodle_url ? `<a href="${p.moodle_url}" target="_blank">Link</a>` : '-'}</td>
                    <td>
                        <button class="action-btn btn-edit" onclick="openModal('labprogram', 'edit', ${p.id})">
                            <i class="material-icons" style="font-size: 14px;">edit</i>
                        </button>
                        <button class="action-btn btn-delete" onclick="deleteItem('labprogram', ${p.id})">
                            <i class="material-icons" style="font-size: 14px;">delete</i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function renderFaqsTable() {
            const tbody = document.querySelector('#faqsTable tbody');
            tbody.innerHTML = faqsData.map(f => `
                <tr>
                    <td>${f.id}</td>
                    <td>${f.question.substring(0, 40)}${f.question.length > 40 ? '...' : ''}</td>
                    <td>${f.answer.substring(0, 40)}${f.answer.length > 40 ? '...' : ''}</td>
                    <td>${f.category || 'general'}</td>
                    <td><span class="badge ${f.is_active ? 'badge-active' : 'badge-inactive'}">${f.is_active ? 'Active' : 'Inactive'}</span></td>
                    <td>
                        <button class="action-btn btn-edit" onclick="openModal('faq', 'edit', ${f.id})">
                            <i class="material-icons" style="font-size: 14px;">edit</i>
                        </button>
                        <button class="action-btn btn-delete" onclick="deleteItem('faq', ${f.id})">
                            <i class="material-icons" style="font-size: 14px;">delete</i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function renderDepartmentsTable() {
            const tbody = document.querySelector('#departmentsTable tbody');
            tbody.innerHTML = departmentsData.map(d => `
                <tr>
                    <td>${d.id}</td>
                    <td>${d.name}</td>
                    <td>${d.code}</td>
                    <td>${d.room_number || '-'}</td>
                    <td>
                        <button class="action-btn btn-edit" onclick="openModal('department', 'edit', ${d.id})">
                            <i class="material-icons" style="font-size: 14px;">edit</i>
                        </button>
                        <button class="action-btn btn-delete" onclick="deleteItem('department', ${d.id})">
                            <i class="material-icons" style="font-size: 14px;">delete</i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function renderDailyEntriesTable(entries = null) {
            const dataToRender = entries || dailyEntriesData;
            const tbody = document.querySelector('#dailyEntriesTable tbody');
            
            if (dataToRender.length === 0) {
                tbody.innerHTML = `<tr><td colspan="9" style="text-align: center; padding: 20px;">No daily entries found</td></tr>`;
                return;
            }
            
            tbody.innerHTML = dataToRender.map(entry => {
                const faculty = facultiesData.find(f => f.id === entry.faculty_id);
                const facultyName = faculty ? faculty.name : 'Unknown';
                const department = faculty ? faculty.department : 'N/A';
                
                let content = '';
                if (entry.entry_type === 'theory') {
                    content = entry.session_title || entry.syllabus_topics || '-';
                } else if (entry.entry_type === 'lab') {
                    content = entry.lab_program_title || '-';
                } else {
                    content = entry.mini_project_work || '-';
                }
                
                const statusBadge = entry.status === 'completed' 
                    ? '<span class="badge badge-active">Completed</span>' 
                    : '<span class="badge badge-inactive">Pending</span>';
                
                return `
                    <tr>
                        <td>${entry.id}</td>
                        <td>${entry.session_date || entry.date}</td>
                        <td>${facultyName}</td>
                        <td>${department}</td>
                        <td>${entry.period || '-'}</td>
                        <td>${entry.entry_type ? (entry.entry_type.charAt(0).toUpperCase() + entry.entry_type.slice(1).replace('_', ' ')) : 'N/A'}</td>
                        <td title="${content}">${content.substring(0, 30)}${content.length > 30 ? '...' : ''}</td>
                        <td>${statusBadge}</td>
                        <td>
                            <button class="action-btn btn-edit" onclick="openModal('dailyentry', 'edit', ${entry.id})">
                                <i class="material-icons" style="font-size: 14px;">edit</i>
                            </button>
                            <button class="action-btn btn-delete" onclick="deleteItem('dailyentry', ${entry.id})">
                                <i class="material-icons" style="font-size: 14px;">delete</i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function populateFacultyFilter() {
            const select = document.getElementById('dailyEntriesFacultyFilter');
            if (!select) return;
            select.innerHTML = '<option value="">All Faculties</option>' + 
                facultiesData.map(f => `<option value="${f.id}">${f.name}</option>`).join('');
        }

        function filterDailyEntries() {
            const startDate = document.getElementById('dailyEntriesStartDate').value;
            const endDate = document.getElementById('dailyEntriesEndDate').value;
            const facultyId = document.getElementById('dailyEntriesFacultyFilter').value;
            const entryType = document.getElementById('dailyEntriesTypeFilter').value;
            
            let filtered = [...dailyEntriesData];
            
            if (startDate) {
                filtered = filtered.filter(e => (e.session_date || e.date) >= startDate);
            }
            if (endDate) {
                filtered = filtered.filter(e => (e.session_date || e.date) <= endDate);
            }
            if (facultyId) {
                filtered = filtered.filter(e => e.faculty_id === parseInt(facultyId));
            }
            if (entryType) {
                filtered = filtered.filter(e => e.entry_type === entryType);
            }
            
            renderDailyEntriesTable(filtered);
        }

        async function loadDailyEntries() {
            showLoading();
            try {
                const result = await apiRequestAuth('/api/super-admin/daily-entries');
                dailyEntriesData = result;
                renderDailyEntriesTable();
                populateFacultyFilter();
            } catch (error) {
                showAlert('Error loading daily entries: ' + error.message);
            }
            hideLoading();
        }

        // Modal functions
        function openModal(type, action, id = null) {
            console.log('Opening modal:', type, action, id);
            currentEditType = type;
            currentEditId = id;
            
            const modal = document.getElementById('crudModal');
            const title = document.getElementById('modalTitle');
            const formContent = document.getElementById('modalFormContent');
            
            title.textContent = action === 'add' ? `Add ${type.charAt(0).toUpperCase() + type.slice(1)}` : `Edit ${type.charAt(0).toUpperCase() + type.slice(1)}`;
            
            let data = null;
            if (action === 'edit') {
                if (type === 'faculty') data = facultiesData.find(f => f.id === id);
                else if (type === 'timetable') data = timetableData.find(t => t.id === id);
                else if (type === 'syllabus') data = syllabusData.find(s => s.id === id);
                else if (type === 'labprogram') data = labProgramsData.find(p => p.id === id);
                else if (type === 'faq') data = faqsData.find(f => f.id === id);
                else if (type === 'department') data = departmentsData.find(d => d.id === id);
                else if (type === 'dailyentry') data = dailyEntriesData.find(e => e.id === id);
                console.log('Found data:', data);
            }
            
            formContent.innerHTML = getFormHTML(type, data);
            modal.classList.add('show');
        }

        function closeModal() {
            document.getElementById('crudModal').classList.remove('show');
            currentEditType = '';
            currentEditId = null;
        }

        function getFormHTML(type, data) {
            switch(type) {
                case 'faculty':
                    return `
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Name *</label>
                                <input type="text" class="form-control" name="name" value="${data?.name || ''}" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Email *</label>
                                <input type="email" class="form-control" name="email" value="${data?.email || ''}" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Password ${data ? '(leave blank to keep)' : '*'}</label>
                                <input type="password" class="form-control" name="password" ${data ? '' : 'required'}>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Phone</label>
                                <input type="text" class="form-control" name="phone" value="${data?.phone || ''}">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Department</label>
                                <input type="text" class="form-control" name="department" value="${data?.department || ''}">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Experience (years)</label>
                                <input type="text" class="form-control" name="experience" value="${data?.experience || ''}">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">C Experience</label>
                                <input type="text" class="form-control" name="c_experience" value="${data?.c_experience || ''}">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Python Experience</label>
                                <input type="text" class="form-control" name="py_experience" value="${data?.py_experience || ''}">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">LinkedIn URL</label>
                                <input type="url" class="form-control" name="linkedin_url" value="${data?.linkedin_url || ''}">
                            </div>
                            <div class="form-group">
                                <label class="form-label">GitHub URL</label>
                                <input type="url" class="form-control" name="github_url" value="${data?.github_url || ''}">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Personal Email</label>
                                <input type="email" class="form-control" name="personal_email" value="${data?.personal_email || ''}">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Research Area</label>
                                <input type="text" class="form-control" name="research_area" value="${data?.research_area || ''}">
                            </div>
                        </div>
                        <div class="form-row single">
                            <div class="form-group">
                                <label class="form-label">Image URL</label>
                                <input type="text" class="form-control" name="image_url" value="${data?.image_url || ''}">
                            </div>
                        </div>
                        ${data ? `
                        <div class="form-row single">
                            <div class="form-group">
                                <label class="form-label">Active Status</label>
                                <select class="form-control" name="is_active">
                                    <option value="true" ${data.is_active ? 'selected' : ''}>Active</option>
                                    <option value="false" ${!data.is_active ? 'selected' : ''}>Inactive</option>
                                </select>
                            </div>
                        </div>
                        ` : ''}
                    `;
                
                case 'timetable':
                    const facultyOptions = facultiesData.map(f => 
                        `<option value="${f.id}" ${data?.faculty_id === f.id ? 'selected' : ''}>${f.name}</option>`
                    ).join('');
                    const deptOptions = departmentsData.map(d => 
                        `<option value="${d.id}" ${data?.department_id === d.id ? 'selected' : ''}>${d.name} (${d.code})</option>`
                    ).join('');
                    return `
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Faculty *</label>
                                <select class="form-control" name="faculty_id" required>
                                    <option value="">Select Faculty</option>
                                    ${facultyOptions}
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Department *</label>
                                <select class="form-control" name="department_id" required>
                                    <option value="">Select Department</option>
                                    ${deptOptions}
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Day *</label>
                                <select class="form-control" name="day" required>
                                    <option value="">Select Day</option>
                                    <option ${data?.day === 'Monday' ? 'selected' : ''}>Monday</option>
                                    <option ${data?.day === 'Tuesday' ? 'selected' : ''}>Tuesday</option>
                                    <option ${data?.day === 'Wednesday' ? 'selected' : ''}>Wednesday</option>
                                    <option ${data?.day === 'Thursday' ? 'selected' : ''}>Thursday</option>
                                    <option ${data?.day === 'Friday' ? 'selected' : ''}>Friday</option>
                                    <option ${data?.day === 'Saturday' ? 'selected' : ''}>Saturday</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Period *</label>
                                <select class="form-control" name="period" required>
                                    <option value="">Select Period</option>
                                    ${[1,2,3,4,5,6,7,8,9].map(p => `<option value="${p}" ${data?.period === p ? 'selected' : ''}>${p}</option>`).join('')}
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Subject Code</label>
                                <input type="text" class="form-control" name="subject_code" value="${data?.subject_code || '24UCS271'}">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Subject Name</label>
                                <input type="text" class="form-control" name="subject_name" value="${data?.subject_name || 'PROG C'}">
                            </div>
                        </div>
                        <div class="form-row single">
                            <div class="form-group">
                                <label class="form-label">Class Type *</label>
                                <select class="form-control" name="class_type" required>
                                    <option value="theory" ${data?.class_type === 'theory' ? 'selected' : ''}>Theory</option>
                                    <option value="lab" ${data?.class_type === 'lab' ? 'selected' : ''}>Lab</option>
                                    <option value="mini_project" ${data?.class_type === 'mini_project' ? 'selected' : ''}>Mini Project</option>
                                </select>
                            </div>
                        </div>
                    `;

                case 'syllabus':
                    return `
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Session Number *</label>
                                <input type="number" class="form-control" name="session_number" value="${data?.session_number || ''}" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Unit *</label>
                                <input type="number" class="form-control" name="unit" value="${data?.unit || ''}" required min="1" max="5">
                            </div>
                        </div>
                        <div class="form-row single">
                            <div class="form-group">
                                <label class="form-label">Session Title *</label>
                                <input type="text" class="form-control" name="session_title" value="${data?.session_title || ''}" required>
                            </div>
                        </div>
                        <div class="form-row single">
                            <div class="form-group">
                                <label class="form-label">Topics</label>
                                <textarea class="form-control" name="topics">${data?.topics || ''}</textarea>
                            </div>
                        </div>
                        <div class="form-row single">
                            <div class="form-group">
                                <label class="form-label">PPT URL</label>
                                <input type="url" class="form-control" name="ppt_url" value="${data?.ppt_url || ''}">
                            </div>
                        </div>
                    `;

                case 'labprogram':
                    return `
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Program Number *</label>
                                <input type="number" class="form-control" name="program_number" value="${data?.program_number || ''}" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Moodle URL</label>
                                <input type="url" class="form-control" name="moodle_url" value="${data?.moodle_url || ''}">
                            </div>
                        </div>
                        <div class="form-row single">
                            <div class="form-group">
                                <label class="form-label">Program Title *</label>
                                <input type="text" class="form-control" name="program_title" value="${data?.program_title || ''}" required>
                            </div>
                        </div>
                        <div class="form-row single">
                            <div class="form-group">
                                <label class="form-label">Description</label>
                                <textarea class="form-control" name="description">${data?.description || ''}</textarea>
                            </div>
                        </div>
                    `;

                case 'faq':
                    return `
                        <div class="form-row single">
                            <div class="form-group">
                                <label class="form-label">Question *</label>
                                <input type="text" class="form-control" name="question" value="${data?.question || ''}" required>
                            </div>
                        </div>
                        <div class="form-row single">
                            <div class="form-group">
                                <label class="form-label">Answer *</label>
                                <textarea class="form-control" name="answer" required>${data?.answer || ''}</textarea>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Category</label>
                                <select class="form-control" name="category">
                                    <option value="general" ${data?.category === 'general' ? 'selected' : ''}>General</option>
                                    <option value="schedule" ${data?.category === 'schedule' ? 'selected' : ''}>Schedule</option>
                                    <option value="faculty" ${data?.category === 'faculty' ? 'selected' : ''}>Faculty</option>
                                    <option value="topics" ${data?.category === 'topics' ? 'selected' : ''}>Topics</option>
                                </select>
                            </div>
                            ${data ? `
                            <div class="form-group">
                                <label class="form-label">Status</label>
                                <select class="form-control" name="is_active">
                                    <option value="true" ${data.is_active ? 'selected' : ''}>Active</option>
                                    <option value="false" ${!data.is_active ? 'selected' : ''}>Inactive</option>
                                </select>
                            </div>
                            ` : ''}
                        </div>
                    `;

                case 'department':
                    return `
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Department Name *</label>
                                <input type="text" class="form-control" name="name" value="${data?.name || ''}" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Code *</label>
                                <input type="text" class="form-control" name="code" value="${data?.code || ''}" required>
                            </div>
                        </div>
                        <div class="form-row single">
                            <div class="form-group">
                                <label class="form-label">Room Number</label>
                                <input type="text" class="form-control" name="room_number" value="${data?.room_number || ''}" placeholder="e.g., 315, 411A">
                            </div>
                        </div>
                    `;

                case 'dailyentry':
                    const entryFacultyOptions = facultiesData.map(f => 
                        `<option value="${f.id}" ${data?.faculty_id === f.id ? 'selected' : ''}>${f.name}</option>`
                    ).join('');
                    return `
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Faculty *</label>
                                <select class="form-control" name="faculty_id" required>
                                    <option value="">Select Faculty</option>
                                    ${entryFacultyOptions}
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Session Date *</label>
                                <input type="date" class="form-control" name="date" value="${data?.session_date || data?.date || ''}" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Period</label>
                                <select class="form-control" name="period">
                                    <option value="">Select Period</option>
                                    ${[1,2,3,4,5,6,7,8,9].map(p => `<option value="${p}" ${data?.period === p ? 'selected' : ''}>${p}</option>`).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Entry Type *</label>
                                <select class="form-control" name="entry_type" id="editEntryType" onchange="toggleEntryFields()" required>
                                    <option value="theory" ${data?.entry_type === 'theory' ? 'selected' : ''}>Theory</option>
                                    <option value="lab" ${data?.entry_type === 'lab' ? 'selected' : ''}>Lab</option>
                                    <option value="mini_project" ${data?.entry_type === 'mini_project' ? 'selected' : ''}>Mini Project</option>
                                </select>
                            </div>
                        </div>
                        <div id="theoryFields" style="display: ${data?.entry_type === 'theory' || !data ? 'block' : 'none'};">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Session Number</label>
                                    <input type="number" class="form-control" name="session_number" value="${data?.session_number || ''}">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Session Title</label>
                                    <input type="text" class="form-control" name="session_title" value="${data?.session_title || ''}">
                                </div>
                            </div>
                            <div class="form-row single">
                                <div class="form-group">
                                    <label class="form-label">Syllabus Topics</label>
                                    <textarea class="form-control" name="syllabus_topics">${data?.syllabus_topics || ''}</textarea>
                                </div>
                            </div>
                        </div>
                        <div id="labFields" style="display: ${data?.entry_type === 'lab' ? 'block' : 'none'};">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Lab Program Number</label>
                                    <input type="number" class="form-control" name="lab_program_number" value="${data?.lab_program_number || ''}">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Lab Program Title</label>
                                    <input type="text" class="form-control" name="lab_program_title" value="${data?.lab_program_title || ''}">
                                </div>
                            </div>
                        </div>
                        <div id="miniProjectFields" style="display: ${data?.entry_type === 'mini_project' ? 'block' : 'none'};">
                            <div class="form-row single">
                                <div class="form-group">
                                    <label class="form-label">Mini Project Work</label>
                                    <textarea class="form-control" name="mini_project_work">${data?.mini_project_work || ''}</textarea>
                                </div>
                            </div>
                        </div>
                        <div class="form-row single">
                            <div class="form-group">
                                <label class="form-label">Notes</label>
                                <textarea class="form-control" name="notes">${data?.notes || ''}</textarea>
                            </div>
                        </div>
                        <div class="form-row single">
                            <div class="form-group">
                                <label class="form-label">Status</label>
                                <select class="form-control" name="status">
                                    <option value="completed" ${data?.status === 'completed' ? 'selected' : ''}>Completed</option>
                                    <option value="pending" ${data?.status === 'pending' ? 'selected' : ''}>Pending</option>
                                </select>
                            </div>
                        </div>
                    `;
            }
        }

        function toggleEntryFields() {
            const entryType = document.getElementById('editEntryType')?.value;
            const theoryFields = document.getElementById('theoryFields');
            const labFields = document.getElementById('labFields');
            const miniProjectFields = document.getElementById('miniProjectFields');
            
            if (theoryFields) theoryFields.style.display = entryType === 'theory' ? 'block' : 'none';
            if (labFields) labFields.style.display = entryType === 'lab' ? 'block' : 'none';
            if (miniProjectFields) miniProjectFields.style.display = entryType === 'mini_project' ? 'block' : 'none';
        }

        async function submitForm(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const data = {};
            
            formData.forEach((value, key) => {
                if (value !== '') {
                    if (key === 'is_active') {
                        data[key] = value === 'true';
                    } else if (['faculty_id', 'department_id', 'period', 'session_number', 'unit', 'program_number', 'lab_program_number'].includes(key)) {
                        data[key] = parseInt(value);
                    } else {
                        data[key] = value;
                    }
                }
            });

            console.log('Submitting form:', currentEditType, currentEditId, data);

            const endpoints = {
                'faculty': '/api/super-admin/faculties',
                'timetable': '/api/super-admin/timetable',
                'syllabus': '/api/super-admin/syllabus',
                'labprogram': '/api/super-admin/lab-programs',
                'faq': '/api/super-admin/faqs',
                'department': '/api/super-admin/departments',
                'dailyentry': '/api/super-admin/daily-entries'
            };

            let endpoint = endpoints[currentEditType];
            let method = 'POST';
            
            if (currentEditId) {
                endpoint += `/${currentEditId}`;
                method = 'PUT';
            }

            console.log('API Call:', method, endpoint);

            showLoading();
            try {
                const result = await apiRequestAuth(endpoint, method, data);
                console.log('API Result:', result);
                if (result && result.message) {
                    showAlert(result.message, 'success');
                    closeModal();
                    await loadAllData();
                } else if (result && result.detail) {
                    showAlert(result.detail, 'error');
                }
            } catch (error) {
                console.error('Submit error:', error);
                showAlert(error.message || 'Error saving data');
            }
            hideLoading();
        }

        async function deleteItem(type, id) {
            if (!confirm('Are you sure you want to delete this item?')) return;

            console.log('Deleting:', type, id);

            const endpoints = {
                'faculty': `/api/super-admin/faculties/${id}`,
                'timetable': `/api/super-admin/timetable/${id}`,
                'syllabus': `/api/super-admin/syllabus/${id}`,
                'labprogram': `/api/super-admin/lab-programs/${id}`,
                'faq': `/api/super-admin/faqs/${id}`,
                'department': `/api/super-admin/departments/${id}`,
                'dailyentry': `/api/super-admin/daily-entries/${id}`
            };

            console.log('Delete API:', endpoints[type]);

            showLoading();
            try {
                const result = await apiRequestAuth(endpoints[type], 'DELETE');
                console.log('Delete result:', result);
                if (result && result.message) {
                    showAlert(result.message, 'success');
                    await loadAllData();
                } else if (result && result.detail) {
                    showAlert(result.detail, 'error');
                }
            } catch (error) {
                console.error('Delete error:', error);
                showAlert(error.message || 'Error deleting item');
            }
            hideLoading();
        }

        // Initialize
        loadAllData();
    </script>
</body>
</html>
